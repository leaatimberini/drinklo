generator client {
  provider = "prisma-client-js"
  output   = "../app/lib/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("CONTROL_PLANE_DATABASE_URL")
}

model Installation {
  id             String   @id @default(uuid())
  instanceId     String   @unique
  domain         String?
  clientName     String?
  primaryRegion  String?
  regionalHealth Json?
  version        String?
  releaseChannel String?
  healthStatus   String?
  searchOk       Boolean?
  lastSeenAt     DateTime?
  lastHeartbeatAt DateTime?
  backupStatus   String?
  lastBackupAt   DateTime?
  sloP95Ms       Float?
  sloErrorRate   Float?
  sloWebhookRetryRate Float?
  sloUpdatedAt   DateTime?
  cpuUsagePct    Float?
  memoryUsedBytes BigInt?
  memoryTotalBytes BigInt?
  diskUsedBytes  BigInt?
  diskTotalBytes BigInt?
  networkRxBytes BigInt?
  networkTxBytes BigInt?
  dbSizeBytes    BigInt?
  storageSizeBytes BigInt?
  jobsProcessed1h Int?
  jobsPending    Int?
  estimatedMonthlyCostUsd Float?
  finopsUpdatedAt DateTime?
  eventsTotal1h  Int?
  eventsFailed1h Int?
  eventsAvgLagMs Int?
  iamSsoEnabled Boolean?
  iamMfaEnforced Boolean?
  iamScimEnabled Boolean?
  iamLastSyncAt DateTime?
  drPlan         String?
  rpoTargetMin   Int?
  rtoTargetMin   Int?
  lastDrillAt    DateTime?
  lastDrillStatus String?
  lastDrillRpoMin Int?
  lastDrillRtoMin Int?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  alerts     Alert[]
  jobFailures JobFailure[]
  updateJobs UpdateJob[]
  backups   BackupRecord[]
  restoreVerifications RestoreVerification[]
  pluginJobs PluginJob[]
  securityReports SecurityReport[]
  drDrills  DisasterRecoveryDrill[]
  billingAccounts BillingAccount[]
  finopsSnapshots FinOpsSnapshot[]
  finopsCosts   FinOpsCostRecord[]
  edgeInvalidations EdgeInvalidation[]
  webVitals   WebVitalSample[]
  chaosRuns   ChaosRun[]
  complianceEvidence ComplianceEvidence[]
  dastFindings DastFinding[]
  accessibilityReports AccessibilityReport[]
  featureUsageSamples FeatureUsageSample[]
  sodAccessReviewReports SodAccessReviewReport[]
  integrationBuilderReports IntegrationBuilderReport[]
  partnerConversions Conversion[]
  mobileBrandProfile MobileBrandProfile?
  mobileBuildProfiles MobileBuildProfile[]
  mobileOtaUpdates MobileOtaUpdate[]
  marketingLeads  MarketingLead[]

  @@index([clientName])
  @@index([domain])
  @@index([healthStatus])
  @@index([primaryRegion])
}

model MobileBrandProfile {
  id               String   @id @default(uuid())
  installationId   String   @unique
  instanceId       String   @unique
  companyId        String?
  appName          String
  appSlug          String
  logoUrl          String?
  iconUrl          String?
  splashUrl        String?
  assets           Json?
  themeTokens      Json
  otaStableChannel String   @default("stable")
  otaBetaChannel   String   @default("beta")
  defaultChannel   String   @default("stable")
  apiBaseUrl       String?
  configVersion    Int      @default(1)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  installation Installation @relation(fields: [installationId], references: [id])
  buildProfiles MobileBuildProfile[]
  otaUpdates    MobileOtaUpdate[]

  @@index([instanceId])
  @@index([companyId])
  @@index([defaultChannel])
}

model MobileBuildProfile {
  id              String   @id @default(uuid())
  installationId  String
  brandProfileId  String?
  instanceId      String
  companyId       String?
  profileName     String
  channel         String
  runtimeVersion  String
  appVersion      String
  status          String   @default("GENERATED")
  config          Json
  generatedBy     String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  installation Installation @relation(fields: [installationId], references: [id])
  brandProfile MobileBrandProfile? @relation(fields: [brandProfileId], references: [id])

  @@index([installationId, createdAt])
  @@index([instanceId, createdAt])
  @@index([channel, createdAt])
}

model MobileOtaUpdate {
  id              String   @id @default(uuid())
  installationId  String
  brandProfileId  String?
  instanceId      String
  companyId       String?
  channel         String
  targetVersion   String
  runtimeVersion  String
  rolloutChannel  String?
  releaseId       String?
  status          String   @default("PUBLISHED")
  message         String?
  manifest        Json?
  publishedBy     String?
  expiresAt       DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  installation Installation @relation(fields: [installationId], references: [id])
  brandProfile MobileBrandProfile? @relation(fields: [brandProfileId], references: [id])

  @@index([installationId, createdAt])
  @@index([instanceId, createdAt])
  @@index([channel, createdAt])
  @@index([status, createdAt])
}

model DastFinding {
  id             String   @id @default(uuid())
  installationId String?
  instanceId     String?
  securityReportId String?
  target         String
  scanProfile    String   @default("ZAP_BASELINE")
  zapRuleId      String
  title          String
  severity       String
  route          String
  evidence       String?
  recommendation String?
  status         String   @default("open")
  firstSeenAt    DateTime @default(now())
  lastSeenAt     DateTime @default(now())
  slaDueAt       DateTime?
  triagedAt      DateTime?
  fixedAt        DateTime?
  metadata       Json?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  installation Installation? @relation(fields: [installationId], references: [id])
  report SecurityReport? @relation(fields: [securityReportId], references: [id])

  @@unique([instanceId, target, zapRuleId, route])
  @@index([installationId, severity, status])
  @@index([status, slaDueAt])
  @@index([lastSeenAt])
}

model ComplianceControl {
  id          String   @id @default(uuid())
  key         String   @unique
  domain      String
  title       String
  description String
  status      String   @default("MONITORED")
  notes       String?
  updatedAt   DateTime @updatedAt
  createdAt   DateTime @default(now())

  evidence ComplianceEvidence[]

  @@index([domain])
  @@index([status])
}

model ComplianceEvidence {
  id             String   @id @default(uuid())
  controlId      String?
  installationId String?
  evidenceType   String
  source         String
  payload        Json
  payloadHash    String
  sourceCapturedAt DateTime
  capturedAt     DateTime @default(now())
  capturedBy     String?
  tags           String[]

  control      ComplianceControl? @relation(fields: [controlId], references: [id])
  installation Installation? @relation(fields: [installationId], references: [id])

  @@index([controlId, capturedAt])
  @@index([installationId, capturedAt])
  @@index([evidenceType, capturedAt])
  @@index([payloadHash])
}

model EdgeInvalidation {
  id             String   @id @default(uuid())
  installationId String?
  instanceId     String
  companyId      String?
  reason         String
  tags           String[]
  paths          String[]
  payload        Json?
  status         String   @default("queued")
  requestedAt    DateTime @default(now())

  installation Installation? @relation(fields: [installationId], references: [id])

  @@index([installationId, requestedAt])
  @@index([instanceId, requestedAt])
  @@index([status])
}

model WebVitalSample {
  id             String   @id @default(uuid())
  installationId String?
  instanceId     String
  shardKey       Int      @default(0)
  name           String
  value          Float
  rating         String?
  path           String?
  metricId       String?
  userAgent      String?
  ip             String?
  capturedAt     DateTime
  createdAt      DateTime @default(now())

  installation Installation? @relation(fields: [installationId], references: [id])

  @@index([installationId, capturedAt])
  @@index([instanceId, capturedAt])
  @@index([shardKey, capturedAt])
  @@index([name, capturedAt])
}

model AccessibilityReport {
  id                String   @id @default(uuid())
  installationId    String?
  instanceId        String
  version           String
  score             Float
  criticalViolations Int     @default(0)
  seriousViolations Int      @default(0)
  totalViolations   Int      @default(0)
  pages             Json?
  measuredAt        DateTime
  createdAt         DateTime @default(now())

  installation Installation? @relation(fields: [installationId], references: [id])

  @@index([installationId, measuredAt])
  @@index([instanceId, measuredAt])
  @@index([version, measuredAt])
}

model FeatureUsageSample {
  id             String   @id @default(uuid())
  installationId String?
  instanceId     String
  shardKey       Int      @default(0)
  version        String?
  feature        String
  action         String
  count          Int
  windowFrom     DateTime
  windowTo       DateTime
  windowMinutes  Int
  capturedAt     DateTime @default(now())

  installation Installation? @relation(fields: [installationId], references: [id])

  @@unique([instanceId, windowFrom, windowTo, feature, action])
  @@index([installationId, capturedAt])
  @@index([instanceId, capturedAt])
  @@index([shardKey, capturedAt])
  @@index([feature, capturedAt])
}

model SodAccessReviewReport {
  id             String   @id @default(uuid())
  installationId String?
  instanceId     String
  companyId      String?
  capturedAt     DateTime
  activePolicies Int      @default(0)
  totalPolicies  Int      @default(0)
  violations24h  Int      @default(0)
  openCampaigns  Int      @default(0)
  overdueCampaigns Int    @default(0)
  payload        Json?
  createdAt      DateTime @default(now())

  installation Installation? @relation(fields: [installationId], references: [id])

  @@index([installationId, capturedAt])
  @@index([instanceId, capturedAt])
  @@index([capturedAt])
}

model IntegrationBuilderReport {
  id              String   @id @default(uuid())
  installationId  String?
  instanceId      String
  shardKey        Int      @default(0)
  companyId       String?
  capturedAt      DateTime
  connectorsTotal Int      @default(0)
  connectorsActive Int     @default(0)
  deliveriesSuccess24h Int @default(0)
  deliveriesFailed24h Int  @default(0)
  dlqOpen         Int      @default(0)
  payload         Json?
  createdAt       DateTime @default(now())

  installation Installation? @relation(fields: [installationId], references: [id])

  @@index([installationId, capturedAt])
  @@index([instanceId, capturedAt])
  @@index([shardKey, capturedAt])
  @@index([capturedAt])
}

model ChaosRun {
  id             String   @id @default(uuid())
  installationId String?
  instanceId     String
  environment    String
  scenario       String
  status         String
  sloP95Ms       Float?
  sloErrorRate   Float?
  sloWebhookRetryRate Float?
  durationMs     Int?
  details        Json?
  createdAt      DateTime @default(now())

  installation Installation? @relation(fields: [installationId], references: [id])

  @@index([installationId, createdAt])
  @@index([instanceId, createdAt])
  @@index([environment, scenario, createdAt])
}

enum BillingAccountStatus {
  ACTIVE
  PAST_DUE
  SUSPENDED
  CANCELED
}

enum BillingProvider {
  MERCADOPAGO
  MANUAL
}

enum BillingPeriod {
  MONTHLY
  YEARLY
}

enum BulkBillingActionType {
  SET_TIER
  EXTEND_TRIAL
  FRAUD_PAUSE
  FRAUD_CANCEL
}

enum BulkBillingActionStatus {
  PENDING_APPROVAL
  APPROVED
  EXECUTING
  EXECUTED
  REJECTED
  FAILED
}

enum TrialCampaignTier {
  C1
  C2
}

enum TrialCampaignStatus {
  ACTIVE
  REVOKED
}

enum TrialRedemptionStatus {
  PENDING_APPROVAL
  REDEEMED
  REJECTED
  BLOCKED
  EXPIRED
}

enum TrialLifecycleEventType {
  TrialStarted
  TrialExtended
  TrialExpired
  PaymentMethodAdded
  ConvertedToPaid
  BecamePastDue
  BecameRestricted
}

enum InvoiceStatus {
  OPEN
  PAID
  VOID
}

enum PartnerStatus {
  ACTIVE
  PAUSED
  BLOCKED
}

enum ReferralLinkStatus {
  ACTIVE
  DISABLED
}

enum LeadStatus {
  CLICKED
  QUALIFIED
  DISQUALIFIED
  CONVERTED
}

enum ConversionStatus {
  ATTRIBUTED
  REVIEW
  REJECTED
  APPROVED
}

enum CommissionPlanType {
  PERCENT_REVENUE
  FLAT_PER_CONVERSION
  HYBRID
}

enum PartnerCertificationRunStatus {
  SUBMITTED
  PASSED
  FAILED
}

enum PartnerCertificationStatus {
  ACTIVE
  EXPIRED
  REVOKED
}

model Partner {
  id             String       @id @default(uuid())
  name           String
  slug           String       @unique
  contactEmail   String?
  websiteDomain  String?
  status         PartnerStatus @default(ACTIVE)
  portalTokenHash String
  notes          String?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  commissionPlans CommissionPlan[]
  referralLinks   ReferralLink[]
  leads           Lead[]
  conversions     Conversion[]
  certificationRuns PartnerCertificationRun[]
  certifications    PartnerCertification[]

  @@index([status])
  @@index([websiteDomain])
}

model PartnerCertificationRun {
  id              String   @id @default(uuid())
  partnerId       String
  kitVersion      String
  reportPayload   Json
  reportHash      String
  signature       String
  status          PartnerCertificationRunStatus @default(SUBMITTED)
  score           Int      @default(0)
  validationErrors Json?
  validationSummary Json?
  submittedAt     DateTime @default(now())
  validatedAt     DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  partner         Partner  @relation(fields: [partnerId], references: [id])
  certifications  PartnerCertification[]

  @@index([partnerId, submittedAt])
  @@index([status, submittedAt])
  @@index([kitVersion])
}

model PartnerCertification {
  id             String   @id @default(uuid())
  partnerId      String
  runId          String?
  scope          String   @default("INTEGRATION_PARTNER")
  status         PartnerCertificationStatus @default(ACTIVE)
  certificateNo  String   @unique
  issuedBy       String?
  issuedAt       DateTime @default(now())
  expiresAt      DateTime
  revokedAt      DateTime?
  revokedReason  String?
  evidenceHash   String?
  payload        Json?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  partner Partner @relation(fields: [partnerId], references: [id])
  run     PartnerCertificationRun? @relation(fields: [runId], references: [id])

  @@index([partnerId, status])
  @@index([expiresAt])
  @@index([issuedAt])
}

model CommissionPlan {
  id                 String             @id @default(uuid())
  partnerId          String
  name               String
  type               CommissionPlanType
  percentRate        Float              @default(0)
  flatAmount         Float              @default(0)
  currency           String             @default("ARS")
  cookieTtlDays      Int                @default(30)
  recurringInvoiceCap Int?              
  active             Boolean            @default(true)
  isDefault          Boolean            @default(false)
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt

  partner      Partner       @relation(fields: [partnerId], references: [id])
  referralLinks ReferralLink[]
  conversions  Conversion[]

  @@index([partnerId, active])
  @@index([partnerId, isDefault])
}

model ReferralLink {
  id               String             @id @default(uuid())
  partnerId        String
  code             String             @unique
  label            String
  targetUrl        String?
  status           ReferralLinkStatus @default(ACTIVE)
  commissionPlanId String?
  metadata         Json?
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt

  partner        Partner         @relation(fields: [partnerId], references: [id])
  commissionPlan CommissionPlan? @relation(fields: [commissionPlanId], references: [id])
  leads          Lead[]
  conversions    Conversion[]

  @@index([partnerId, status])
  @@index([commissionPlanId])
}

model Lead {
  id              String     @id @default(uuid())
  partnerId       String
  referralLinkId  String?
  cookieId        String?
  email           String?
  emailDomain     String?
  installationDomain String?
  utmSource       String?
  utmMedium       String?
  utmCampaign     String?
  utmTerm         String?
  utmContent      String?
  landingUrl      String?
  sourceUrl       String?
  ipAddress       String?
  userAgent       String?
  status          LeadStatus  @default(CLICKED)
  fraudScore      Int         @default(0)
  fraudFlags      Json?
  fraudReason     String?
  metadata        Json?
  convertedAt     DateTime?
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  partner      Partner       @relation(fields: [partnerId], references: [id])
  referralLink ReferralLink? @relation(fields: [referralLinkId], references: [id])
  conversions  Conversion[]

  @@index([partnerId, createdAt])
  @@index([referralLinkId, createdAt])
  @@index([cookieId])
  @@index([emailDomain])
  @@index([ipAddress])
  @@index([status])
}

model Conversion {
  id                     String           @id @default(uuid())
  partnerId              String
  referralLinkId         String?
  leadId                 String?
  commissionPlanId       String?
  installationId         String?
  billingAccountId       String?
  instanceId             String?
  status                 ConversionStatus @default(ATTRIBUTED)
  attributionSource      String           @default("cookie+utm")
  attributedAt           DateTime         @default(now())
  approvedAt             DateTime?
  rejectedAt             DateTime?
  rejectionReason        String?
  accountCreationIp      String?
  accountEmailDomain     String?
  installationDomain     String?
  fraudScore             Int              @default(0)
  fraudFlags             Json?
  estimatedRevenueAmount Float            @default(0)
  estimatedCommissionAmount Float         @default(0)
  commissionCurrency     String           @default("ARS")
  invoiceCountApplied    Int              @default(0)
  commissionSnapshot     Json?
  metadata               Json?
  createdAt              DateTime         @default(now())
  updatedAt              DateTime         @updatedAt

  partner        Partner         @relation(fields: [partnerId], references: [id])
  referralLink   ReferralLink?   @relation(fields: [referralLinkId], references: [id])
  lead           Lead?           @relation(fields: [leadId], references: [id])
  commissionPlan CommissionPlan? @relation(fields: [commissionPlanId], references: [id])
  installation   Installation?   @relation(fields: [installationId], references: [id])
  billingAccount BillingAccount? @relation(fields: [billingAccountId], references: [id])

  @@unique([billingAccountId])
  @@index([partnerId, createdAt])
  @@index([leadId])
  @@index([installationId])
  @@index([instanceId])
  @@index([status])
}

model BillingPlan {
  id         String   @id @default(uuid())
  name       String
  price      Float
  currency   String
  period     BillingPeriod
  features   String[]
  trialDays  Int      @default(0)
  includedOrdersPerMonth Int @default(0)
  gmvIncludedArs Float @default(0)
  overagePerOrderArs Float @default(0)
  gmvTiers    Json?
  rpoTargetMin Int?
  rtoTargetMin Int?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  accounts BillingAccount[]
  prices   PlanPrice[]

  @@index([name])
}

model PlanPrice {
  id           String        @id @default(uuid())
  planId        String?
  tier          String
  billingPeriod BillingPeriod
  currency      String
  amount        Float
  effectiveFrom DateTime
  effectiveTo   DateTime?
  notes         String?
  createdBy     String?
  updatedBy     String?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  plan BillingPlan? @relation(fields: [planId], references: [id])

  @@index([tier, billingPeriod, currency, effectiveFrom])
  @@index([effectiveFrom, effectiveTo])
  @@index([planId])
}

model BillingAccount {
  id           String   @id @default(uuid())
  installationId String
  instanceId   String   @unique
  clientName   String?
  email        String?
  planId       String
  status       BillingAccountStatus @default(ACTIVE)
  provider     BillingProvider @default(MANUAL)
  externalId   String?
  nextBillingAt DateTime?
  warningCount Int @default(0)
  trialEndsAt  DateTime?
  currentPeriodStart DateTime?
  currentPeriodEnd DateTime?
  monthlyOrders Int @default(0)
  monthlyGmvArs Float @default(0)
  softLimitedAt DateTime?
  hardLimitedAt DateTime?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  installation Installation @relation(fields: [installationId], references: [id])
  plan         BillingPlan  @relation(fields: [planId], references: [id])
  invoices     BillingInvoice[]
  payments     BillingPayment[]
  usageRecords BillingUsageRecord[]
  planChanges  BillingPlanChange[]
  partnerConversions Conversion[]

  @@index([installationId])
  @@index([planId])
  @@index([status])
}

model BillingUsageRecord {
  id         String   @id @default(uuid())
  accountId  String
  periodStart DateTime
  periodEnd  DateTime
  ordersCount Int @default(0)
  gmvArs     Float @default(0)
  estimatedAmount Float @default(0)
  createdAt  DateTime @default(now())

  account BillingAccount @relation(fields: [accountId], references: [id])

  @@index([accountId, periodStart, periodEnd])
}

model BillingPlanChange {
  id         String   @id @default(uuid())
  accountId  String
  fromPlanId String
  toPlanId   String
  effectiveAt DateTime @default(now())
  prorationAmount Float @default(0)
  reason     String?
  createdAt  DateTime @default(now())

  account BillingAccount @relation(fields: [accountId], references: [id])

  @@index([accountId, effectiveAt])
}

model BillingInvoice {
  id          String   @id @default(uuid())
  accountId   String
  amount      Float
  currency    String
  status      InvoiceStatus @default(OPEN)
  dueAt       DateTime
  paidAt      DateTime?
  provider    BillingProvider
  externalId  String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  account  BillingAccount @relation(fields: [accountId], references: [id])
  payments BillingPayment[]

  @@index([accountId])
  @@index([status])
  @@index([dueAt])
}

model BillingPayment {
  id         String   @id @default(uuid())
  accountId  String
  invoiceId  String?
  provider   BillingProvider
  status     String
  amount     Float
  currency   String
  externalId String?
  raw        Json?
  createdAt  DateTime @default(now())

  account BillingAccount @relation(fields: [accountId], references: [id])
  invoice BillingInvoice? @relation(fields: [invoiceId], references: [id])

  @@index([accountId])
  @@index([invoiceId])
  @@index([provider])
  @@index([status])
}

model Alert {
  id             String   @id @default(uuid())
  installationId String
  level          String
  message        String
  createdAt      DateTime @default(now())

  installation Installation @relation(fields: [installationId], references: [id])

  @@index([installationId])
  @@index([level])
}

model JobFailure {
  id             String   @id @default(uuid())
  installationId String
  queue          String?
  message        String
  createdAt      DateTime @default(now())

  installation Installation @relation(fields: [installationId], references: [id])

  @@index([installationId])
  @@index([queue])
}

model ReleaseManifest {
  id                 String   @id @default(uuid())
  version            String
  sha                String
  channel            String
  migrationsRequired Boolean  @default(false)
  breakingChanges    String?
  releasedAt         DateTime @default(now())
  signature          String
  createdAt          DateTime @default(now())

  rollouts  Rollout[]
  updateJobs UpdateJob[]

  @@index([version])
  @@index([channel])
}

model Rollout {
  id          String   @id @default(uuid())
  manifestId  String
  channel     String
  batchSize   Int
  strategy    String   @default("BATCH")
  canarySteps Int[]
  canaryStepWaitSec Int @default(120)
  sloP95Max   Float?
  sloErrorRateMax Float?
  sloWebhookRetryRateMax Float?
  autoRollback Boolean @default(true)
  batchIndex  Int      @default(0)
  status      String   @default("running")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  manifest ReleaseManifest @relation(fields: [manifestId], references: [id])
  batches  RolloutBatch[]

  @@index([channel])
  @@index([status])
}

model RolloutBatch {
  id         String   @id @default(uuid())
  rolloutId  String
  batchIndex Int
  status     String   @default("running")
  startedAt  DateTime @default(now())
  finishedAt DateTime?
  createdAt  DateTime @default(now())

  rollout   Rollout @relation(fields: [rolloutId], references: [id])
  updateJobs UpdateJob[]

  @@unique([rolloutId, batchIndex])
  @@index([status])
}

model UpdateJob {
  id             String   @id @default(uuid())
  installationId String
  manifestId     String
  batchId        String
  status         String   @default("pending")
  step           String?
  error          String?
  canaryPercent  Int?
  metricP95Ms    Float?
  metricErrorRate Float?
  metricWebhookRetryRate Float?
  meta           Json?
  startedAt      DateTime?
  finishedAt     DateTime?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  installation Installation @relation(fields: [installationId], references: [id])
  manifest     ReleaseManifest @relation(fields: [manifestId], references: [id])
  batch        RolloutBatch @relation(fields: [batchId], references: [id])

  @@index([installationId])
  @@index([status])
}

model BackupRecord {
  id             String   @id @default(uuid())
  installationId String
  instanceId     String
  backupId       String?
  createdAt      DateTime @default(now())
  sizeBytes      Int?
  checksum       String?
  bucket         String?
  path           String?
  meta           Json?

  installation Installation @relation(fields: [installationId], references: [id])

  @@index([installationId])
  @@index([instanceId])
  @@index([createdAt])
  @@index([checksum])
}

model RestoreVerification {
  id             String   @id @default(uuid())
  installationId String
  instanceId     String
  status         String   @default("scheduled")
  environment    String   @default("staging")
  scheduledAt    DateTime @default(now())
  startedAt      DateTime?
  finishedAt     DateTime?
  message        String?
  meta           Json?

  installation Installation @relation(fields: [installationId], references: [id])

  @@index([installationId])
  @@index([instanceId])
  @@index([status])
  @@index([scheduledAt])
}

model PluginRelease {
  id            String   @id @default(uuid())
  publisherId   String?
  sourceSubmissionId String?
  name          String
  version       String
  channel       String
  compatibility String?
  compatibilityMatrix Json?
  changelog     String?
  signature     String
  permissions   String[] @default([])
  dependencies  String[] @default([])
  reviewStatus  String   @default("approved")
  certified     Boolean  @default(false)
  certifiedAt   DateTime?
  certificationReport Json?
  createdAt     DateTime @default(now())

  publisher     Publisher? @relation(fields: [publisherId], references: [id])
  sourceSubmission PluginSubmission? @relation(fields: [sourceSubmissionId], references: [id])
  reviews       PluginMarketplaceReview[]

  @@unique([name, version, channel])
  @@index([name])
  @@index([version])
  @@index([channel])
  @@index([publisherId])
}

model PluginRequest {
  id         String   @id @default(uuid())
  instanceId String
  pluginName String
  version    String?
  action     String
  status     String   @default("pending")
  requestedAt DateTime @default(now())
  approvedAt DateTime?

  @@index([instanceId])
  @@index([pluginName])
  @@index([status])
}

model Publisher {
  id                   String   @id @default(uuid())
  name                 String
  email                String
  website              String?
  verificationStatus   String   @default("PENDING")
  verificationNotes    String?
  verifiedAt           DateTime?
  apiKey               String   @unique
  signingSecret        String
  defaultRevenueShareBps Int?
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  submissions PluginSubmission[]
  releases    PluginRelease[]

  @@index([verificationStatus])
  @@index([email])
}

model PluginSubmission {
  id                 String   @id @default(uuid())
  publisherId        String
  pluginName         String
  version            String
  channel            String
  compatibility      String?
  compatibilityMatrix Json?
  changelog          String?
  bundleUrl          String
  manifest           Json
  signature          String
  requestedPermissions String[] @default([])
  dependencies       String[] @default([])
  revenueShareBps    Int?
  status             String   @default("UNDER_REVIEW")
  reviewReport       Json?
  reviewedBy         String?
  reviewedAt         DateTime?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  publisher Publisher @relation(fields: [publisherId], references: [id])
  releases  PluginRelease[]

  @@unique([publisherId, pluginName, version, channel])
  @@index([publisherId])
  @@index([status])
  @@index([pluginName, version])
}

model PluginMarketplaceReview {
  id           String   @id @default(uuid())
  pluginName   String
  releaseId    String?
  version      String?
  rating       Int
  title        String?
  body         String?
  reviewerName String
  status       String   @default("PUBLISHED")
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  release PluginRelease? @relation(fields: [releaseId], references: [id])

  @@index([pluginName])
  @@index([releaseId])
  @@index([status])
  @@index([createdAt])
}

model PluginRollout {
  id        String   @id @default(uuid())
  pluginName String
  version   String
  channel   String
  batchSize Int
  batchIndex Int @default(0)
  status    String @default("running")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  batches PluginRolloutBatch[]

  @@index([pluginName])
  @@index([channel])
  @@index([status])
}

model PluginRolloutBatch {
  id        String   @id @default(uuid())
  rolloutId String
  batchIndex Int
  status    String   @default("running")
  startedAt DateTime @default(now())
  finishedAt DateTime?
  createdAt DateTime @default(now())

  rollout PluginRollout @relation(fields: [rolloutId], references: [id])
  jobs    PluginJob[]

  @@unique([rolloutId, batchIndex])
  @@index([status])
}

model PluginJob {
  id            String   @id @default(uuid())
  installationId String
  instanceId     String
  pluginName    String
  version       String?
  action        String
  status        String   @default("pending")
  step          String?
  error         String?
  durationMs    Int?
  startedAt     DateTime?
  finishedAt    DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  batchId       String?

  installation Installation @relation(fields: [installationId], references: [id])
  batch        PluginRolloutBatch? @relation(fields: [batchId], references: [id])

  @@index([installationId])
  @@index([instanceId])
  @@index([pluginName])
  @@index([status])
}

model SecurityReport {
  id          String   @id @default(uuid())
  installationId String?
  instanceId  String?
  repo        String?
  sha         String?
  runId       String?
  kind        String
  status      String
  summary     Json?
  createdAt   DateTime @default(now())

  installation Installation? @relation(fields: [installationId], references: [id])
  dastFindings DastFinding[]

  @@index([installationId])
  @@index([instanceId])
  @@index([repo])
  @@index([kind])
  @@index([status])
  @@index([createdAt])
}

model DisasterRecoveryDrill {
  id             String   @id @default(uuid())
  installationId String
  instanceId     String
  status         String   @default("scheduled")
  rpoMinutes     Int?
  rtoMinutes     Int?
  startedAt      DateTime @default(now())
  finishedAt     DateTime?
  notes          String?
  meta           Json?

  installation Installation @relation(fields: [installationId], references: [id])

  @@index([installationId])
  @@index([instanceId])
  @@index([status])
  @@index([startedAt])
  @@index([finishedAt])
}

model FinOpsPricing {
  id            String   @id @default(uuid())
  resourceKey   String   @unique
  unit          String
  usdPerUnit    Float
  description   String?
  enabled       Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([enabled])
}

model FinOpsSnapshot {
  id             String   @id @default(uuid())
  installationId String
  recordedAt     DateTime @default(now())
  cpuUsagePct    Float?
  memoryUsedBytes BigInt?
  memoryTotalBytes BigInt?
  diskUsedBytes  BigInt?
  diskTotalBytes BigInt?
  networkRxBytes BigInt?
  networkTxBytes BigInt?
  dbSizeBytes    BigInt?
  storageSizeBytes BigInt?
  jobsFailed     Int?
  jobsProcessed1h Int?
  jobsPending    Int?
  estimatedMonthlyCostUsd Float?
  meta           Json?

  installation Installation @relation(fields: [installationId], references: [id])

  @@index([installationId, recordedAt])
}

model FinOpsCostRecord {
  id             String   @id @default(uuid())
  installationId String
  periodStart    DateTime
  periodEnd      DateTime
  estimatedCostUsd Float
  breakdown      Json?
  createdAt      DateTime @default(now())

  installation Installation @relation(fields: [installationId], references: [id])

  @@index([installationId, periodStart, periodEnd])
}

model BulkBillingAction {
  id                     String                @id @default(uuid())
  actionType             BulkBillingActionType
  status                 BulkBillingActionStatus @default(PENDING_APPROVAL)
  requestedByRole        String
  requestedByActor       String?
  approvedByRoles        String[]              @default([])
  approvalsNeeded        Int                   @default(1)
  requiresTwoPersonApproval Boolean            @default(false)
  manifestHash           String
  evidenceSignature      String
  targetCount            Int                   @default(0)
  payload                Json
  result                 Json?
  note                   String?
  error                  String?
  createdAt              DateTime              @default(now())
  updatedAt              DateTime              @updatedAt
  approvedAt             DateTime?
  executedAt             DateTime?
  rejectedAt             DateTime?

  approvals BulkBillingActionApproval[]

  @@index([status, createdAt])
  @@index([actionType, createdAt])
  @@index([requestedByRole, createdAt])
  @@index([manifestHash])
}

model BulkBillingActionApproval {
  id            String   @id @default(uuid())
  actionId       String
  approverRole   String
  approverActor  String?
  decision       String   @default("APPROVE")
  note           String?
  manifestHash   String
  evidenceSignature String
  createdAt      DateTime @default(now())

  action BulkBillingAction @relation(fields: [actionId], references: [id], onDelete: Cascade)

  @@unique([actionId, approverRole, decision])
  @@index([actionId, createdAt])
  @@index([approverRole, createdAt])
}

model TrialCampaign {
  id              String             @id @default(uuid())
  code            String             @unique
  tier            TrialCampaignTier
  durationDays    Int
  maxRedemptions  Int?
  expiresAt       DateTime?
  requiresApproval Boolean           @default(false)
  allowedDomains  String[]           @default([])
  blockedDomains  String[]           @default([])
  notes           String?
  status          TrialCampaignStatus @default(ACTIVE)
  revokedAt       DateTime?
  createdBy       String?
  updatedBy       String?
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt

  @@index([status, createdAt])
  @@index([tier, createdAt])
  @@index([expiresAt])
}

model TrialRedemption {
  id              String               @id @default(uuid())
  campaignId      String
  companyId       String?
  instanceId      String?
  billingAccountId String?
  email           String?
  emailDomain     String?
  ipHash          String?
  fingerprintHash String?
  redeemedAt      DateTime             @default(now())
  status          TrialRedemptionStatus @default(REDEEMED)
  reason          String?
  metadata        Json?
  createdAt       DateTime             @default(now())
  updatedAt       DateTime             @updatedAt

  @@index([campaignId, redeemedAt])
  @@index([campaignId, status, redeemedAt])
  @@index([emailDomain, redeemedAt])
  @@index([fingerprintHash, redeemedAt])
  @@index([ipHash, redeemedAt])
  @@index([instanceId])
  @@index([billingAccountId])
}

model LeadAttribution {
  id               String   @id @default(uuid())
  campaignId       String?
  redemptionId     String?
  companyId        String?
  instanceId       String?
  utmSource        String?
  utmCampaign      String?
  referral         String?
  landing          String?
  utmMedium        String?
  utmTerm          String?
  utmContent       String?
  businessType     String?
  ipHash           String?
  fingerprintHash  String?
  createdAt        DateTime @default(now())
  marketingLeads   MarketingLead[]

  @@index([campaignId, createdAt])
  @@index([redemptionId])
  @@index([instanceId])
  @@index([utmSource, utmCampaign, createdAt])
}

model MarketingLead {
  id               String   @id @default(uuid())
  installationId   String?
  instanceId       String?
  companyId        String?
  leadAttributionId String?
  email            String
  businessType     String
  city             String?
  trialCode        String?
  source           String   @default("marketing-site")
  status           String   @default("CAPTURED")
  notes            String?
  metadata         Json?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  installation   Installation?  @relation(fields: [installationId], references: [id])
  leadAttribution LeadAttribution? @relation(fields: [leadAttributionId], references: [id])

  @@index([email, createdAt])
  @@index([businessType, createdAt])
  @@index([trialCode, createdAt])
  @@index([instanceId, createdAt])
  @@index([status, createdAt])
}

model TrialLifecycleEvent {
  id              String                 @id @default(uuid())
  eventType       TrialLifecycleEventType
  campaignId      String?
  redemptionId    String?
  billingAccountId String?
  installationId  String?
  instanceId      String?
  businessType    String?
  eventAt         DateTime
  dedupeKey       String?                @unique
  source          String?
  properties      Json?
  createdAt       DateTime               @default(now())

  @@index([campaignId, eventAt])
  @@index([eventType, eventAt])
  @@index([instanceId, eventAt])
  @@index([billingAccountId, eventAt])
  @@index([businessType, eventAt])
}
