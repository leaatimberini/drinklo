services:
  api:
    image: erp-api:latest
    container_name: erp-api
    env_file:
      - .env
    depends_on:
      - postgres
      - redis
      - clickhouse
      - meilisearch
    ports:
      - "3001:3001"

  admin:
    image: erp-admin:latest
    container_name: erp-admin
    env_file:
      - .env
    depends_on:
      - api
    ports:
      - "3002:3002"

  storefront:
    image: erp-storefront:latest
    container_name: erp-storefront
    env_file:
      - .env
    depends_on:
      - api
    ports:
      - "3003:3003"

  bot:
    image: erp-bot:latest
    container_name: erp-bot
    env_file:
      - .env
    depends_on:
      - api
    ports:
      - "3004:3004"

  postgres:
    image: postgres:16
    container_name: erp-postgres
    environment:
      POSTGRES_USER: erp
      POSTGRES_PASSWORD: erp
      POSTGRES_DB: erp
    volumes:
      - erp_pgdata:/var/lib/postgresql/data

  redis:
    image: redis:7
    container_name: erp-redis
    volumes:
      - erp_redis:/data

  meilisearch:
    image: getmeili/meilisearch:v1.6
    container_name: erp-meilisearch
    environment:
      MEILI_MASTER_KEY: ${MEILI_API_KEY:-}
    volumes:
      - erp_meili:/meili_data

  clickhouse:
    image: clickhouse/clickhouse-server:24.8
    container_name: erp-clickhouse
    environment:
      CLICKHOUSE_DB: ${CLICKHOUSE_DB:-erp_warehouse}
      CLICKHOUSE_USER: ${CLICKHOUSE_USER:-erp}
      CLICKHOUSE_PASSWORD: ${CLICKHOUSE_PASSWORD:-erp}
    volumes:
      - erp_clickhouse:/var/lib/clickhouse

  minio:
    image: minio/minio:latest
    container_name: erp-minio
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: ${STORAGE_ACCESS_KEY:-minioadmin}
      MINIO_ROOT_PASSWORD: ${STORAGE_SECRET_KEY:-minioadmin}
    volumes:
      - erp_minio:/data

  backup:
    image: node:24-bookworm
    container_name: erp-backup
    env_file:
      - .env
    environment:
      BACKUP_DIR: /backups
      BACKUP_RETENTION_DAYS: ${BACKUP_RETENTION_DAYS:-30}
      BACKUP_ENCRYPTION_KEY: ${BACKUP_ENCRYPTION_KEY:-}
      BACKUP_REDIS: ${BACKUP_REDIS:-true}
      BACKUP_STORAGE: ${BACKUP_STORAGE:-true}
    volumes:
      - ../../:/app
      - erp_backups:/backups
      - ./backup:/backup
    command: ["/bin/sh", "/backup/entrypoint.sh"]
    depends_on:
      - postgres
      - redis
      - minio

  caddy:
    image: caddy:2
    container_name: erp-caddy
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    environment:
      DOMAIN: ${DOMAIN}
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy_data:/data
      - caddy_config:/config
    depends_on:
      - api
      - admin
      - storefront
      - bot

volumes:
  erp_pgdata:
  erp_redis:
  erp_clickhouse:
  erp_meili:
  erp_minio:
  erp_backups:
  caddy_data:
  caddy_config:
