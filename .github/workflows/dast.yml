name: DAST

on:
  workflow_dispatch:
  schedule:
    - cron: "30 4 * * 2"

jobs:
  dast:
    runs-on: ubuntu-latest
    if: ${{ secrets.DAST_API_URL != '' && secrets.DAST_STOREFRONT_URL != '' }}
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
        with:
          version: 9
      - uses: actions/setup-node@v4
        with:
          node-version: 24
          cache: pnpm
      - run: pnpm install
      - run: npx playwright install --with-deps
      - run: pnpm e2e -- tests/e2e/dast.spec.ts
        env:
          DAST_API_URL: ${{ secrets.DAST_API_URL }}
          DAST_STOREFRONT_URL: ${{ secrets.DAST_STOREFRONT_URL }}

  dast-report:
    runs-on: ubuntu-latest
    if: always()
    needs: [dast]
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
        with:
          version: 9
      - uses: actions/setup-node@v4
        with:
          node-version: 24
          cache: pnpm
      - run: pnpm install
      - name: Send report to control-plane
        env:
          CONTROL_PLANE_URL: ${{ secrets.CONTROL_PLANE_URL }}
          CONTROL_PLANE_SECURITY_TOKEN: ${{ secrets.CONTROL_PLANE_SECURITY_TOKEN }}
          SECURITY_REPORT_KIND: dast
          SECURITY_REPORT_STATUS: ${{ needs.dast.result }}
          SECURITY_REPORT_REPO: ${{ github.repository }}
          SECURITY_REPORT_SHA: ${{ github.sha }}
          SECURITY_REPORT_RUN_ID: ${{ github.run_id }}
          SECURITY_REPORT_SUMMARY: >
            {"dast":"${{ needs.dast.result }}"}
        run: node scripts/security-report.mjs
