name: CI

on:
  push:
    branches: ["main"]
  pull_request:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
        with:
          version: 9.15.0
      - uses: actions/setup-node@v4
        with:
          node-version: 24.x
          cache: pnpm
          cache-dependency-path: pnpm-lock.yaml
      - run: pnpm install
      - run: pnpm lint
      - run: pnpm test
      - run: pnpm build

  gitleaks:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: gitleaks/gitleaks-action@v2

  trivy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Build images
        run: |
          docker build -f apps/api/Dockerfile -t local/erp-api:ci .
          docker build -f apps/admin/Dockerfile -t local/erp-admin:ci .
          docker build -f apps/storefront/Dockerfile -t local/erp-storefront:ci .
          docker build -f apps/bot/Dockerfile -t local/erp-bot:ci .
      - name: Scan api image
        uses: aquasecurity/trivy-action@0.24.0
        with:
          image-ref: local/erp-api:ci
          severity: CRITICAL
          ignore-unfixed: true
          exit-code: 1
          ignorefile: .trivyignore
      - name: Scan admin image
        uses: aquasecurity/trivy-action@0.24.0
        with:
          image-ref: local/erp-admin:ci
          severity: CRITICAL
          ignore-unfixed: true
          exit-code: 1
          ignorefile: .trivyignore
      - name: Scan storefront image
        uses: aquasecurity/trivy-action@0.24.0
        with:
          image-ref: local/erp-storefront:ci
          severity: CRITICAL
          ignore-unfixed: true
          exit-code: 1
          ignorefile: .trivyignore
      - name: Scan bot image
        uses: aquasecurity/trivy-action@0.24.0
        with:
          image-ref: local/erp-bot:ci
          severity: CRITICAL
          ignore-unfixed: true
          exit-code: 1
          ignorefile: .trivyignore

  security-report:
    runs-on: ubuntu-latest
    if: always()
    needs: [build, gitleaks, trivy]
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
        with:
          version: 9.15.0
      - uses: actions/setup-node@v4
        with:
          node-version: 24.x
          cache: pnpm
          cache-dependency-path: pnpm-lock.yaml
      - run: pnpm install
      - name: Send report to control-plane
        env:
          CONTROL_PLANE_URL: ${{ secrets.CONTROL_PLANE_URL }}
          CONTROL_PLANE_SECURITY_TOKEN: ${{ secrets.CONTROL_PLANE_SECURITY_TOKEN }}
          SECURITY_REPORT_KIND: ci
          SECURITY_REPORT_STATUS: ${{ job.status }}
          SECURITY_REPORT_REPO: ${{ github.repository }}
          SECURITY_REPORT_SHA: ${{ github.sha }}
          SECURITY_REPORT_RUN_ID: ${{ github.run_id }}
          SECURITY_REPORT_SUMMARY: >
            {"build":"${{ needs.build.result }}","gitleaks":"${{ needs.gitleaks.result }}","trivy":"${{ needs.trivy.result }}"}
        run: node scripts/security-report.mjs

  performance:
    runs-on: ubuntu-latest
    if: ${{ secrets.PERF_BASE_URL != '' }}
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
        with:
          version: 9.15.0
      - uses: actions/setup-node@v4
        with:
          node-version: 24.x
          cache: pnpm
          cache-dependency-path: pnpm-lock.yaml
      - run: pnpm install
      - run: pnpm perf
        env:
          PERF_BASE_URL: ${{ secrets.PERF_BASE_URL }}
          PERF_ADMIN_TOKEN: ${{ secrets.PERF_ADMIN_TOKEN }}
          PERF_STOREFRONT_URL: ${{ secrets.PERF_STOREFRONT_URL }}
          PERF_P95_CATALOG_MS: ${{ secrets.PERF_P95_CATALOG_MS }}
          PERF_P95_CHECKOUT_MS: ${{ secrets.PERF_P95_CHECKOUT_MS }}
          PERF_P95_ADMIN_MS: ${{ secrets.PERF_P95_ADMIN_MS }}
          PERF_TTFB_MS: ${{ secrets.PERF_TTFB_MS }}
          PERF_LCP_MS: ${{ secrets.PERF_LCP_MS }}

  billing-e2e-staging:
    runs-on: ubuntu-latest
    if: ${{ secrets.BILLING_E2E_API_URL != '' && secrets.BILLING_E2E_DATABASE_URL != '' }}
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
        with:
          version: 9.15.0
      - uses: actions/setup-node@v4
        with:
          node-version: 24.x
          cache: pnpm
          cache-dependency-path: pnpm-lock.yaml
      - run: pnpm install
      - run: pnpm -C apps/control-plane prisma:generate
      - run: pnpm exec playwright install --with-deps chromium
      - name: Run billing E2E (staging mocks)
        env:
          BILLING_E2E_ENABLE_MUTATIONS: "true"
          BILLING_E2E_PROFILE: "staging-mocks"
          BILLING_E2E_API_URL: ${{ secrets.BILLING_E2E_API_URL }}
          BILLING_E2E_ADMIN_URL: ${{ secrets.BILLING_E2E_ADMIN_URL }}
          BILLING_E2E_STOREFRONT_URL: ${{ secrets.BILLING_E2E_STOREFRONT_URL }}
          BILLING_E2E_CONTROL_PLANE_URL: ${{ secrets.BILLING_E2E_CONTROL_PLANE_URL }}
          BILLING_E2E_DATABASE_URL: ${{ secrets.BILLING_E2E_DATABASE_URL }}
          BILLING_E2E_CONTROL_PLANE_DATABASE_URL: ${{ secrets.BILLING_E2E_CONTROL_PLANE_DATABASE_URL }}
          BILLING_E2E_CONTROL_PLANE_ADMIN_TOKEN: ${{ secrets.BILLING_E2E_CONTROL_PLANE_ADMIN_TOKEN }}
          BILLING_E2E_ADMIN_EMAIL: ${{ secrets.BILLING_E2E_ADMIN_EMAIL }}
          BILLING_E2E_ADMIN_PASSWORD: ${{ secrets.BILLING_E2E_ADMIN_PASSWORD }}
          PAYMENT_SANDBOX: "true"
          AFIP_SANDBOX: "true"
          INTEGRATIONS_MOCK: "true"
        run: pnpm exec playwright test tests/e2e/billing.spec.ts
